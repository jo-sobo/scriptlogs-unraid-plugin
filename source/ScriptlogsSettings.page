Menu="Utilities"
Icon="ScriptLogsLogo.png"
Title="Scriptlogs Settings"
---
<?php
require_once '/usr/local/emhttp/plugins/dynamix/include/Helpers.php';

$plugin_name = 'scriptlogs';
$cfg_file = "/boot/config/plugins/{$plugin_name}/{$plugin_name}.cfg";

// Save the new settings when the form is submitted
if (isset($_POST['#apply'])) {
  $new_cfg = [
    'REFRESH_ENABLED' => $_POST['REFRESH_ENABLED'],
    'REFRESH_INTERVAL' => $_POST['REFRESH_INTERVAL'],
    'ENABLED_SCRIPTS' => isset($_POST['ENABLED_SCRIPTS']) ? implode(',', $_POST['ENABLED_SCRIPTS']) : '',
    'SHOW_IDLE_LOGS' => isset($_POST['SHOW_IDLE_LOGS']) ? '1' : '0'
  ];

  $ini = '';
  foreach ($new_cfg as $key => $value) {
    $ini .= "{$key}=\"{$value}\"\n";
  }
  file_put_contents($cfg_file, $ini);
  
  $cfg = $new_cfg;
} else {
  $cfg = parse_plugin_cfg($plugin_name, true);
}

// Find all available user scripts
$user_scripts_path = '/boot/config/plugins/user.scripts/scripts';
$available_scripts = [];
if (is_dir($user_scripts_path)) {
  $scripts = array_diff(scandir($user_scripts_path), ['.', '..']);
  foreach ($scripts as $script_name) {
    if (is_dir("{$user_scripts_path}/{$script_name}")) {
      $available_scripts[] = $script_name;
    }
  }
}

$enabled_scripts_array = isset($cfg['ENABLED_SCRIPTS']) ? explode(',', $cfg['ENABLED_SCRIPTS']) : [];
?>

<form name="scriptlogs_settings" method="post" class="scriptlogs-settings">
  <div class="content scriptlogs-settings-section" markdown="1">
  ### _(General Settings)_

  <dl class="page-settings">
  _(Automatic Refresh)_:
  : <span class="scriptlogs-control">
      <select name="REFRESH_ENABLED" class="form-control">
        <?php echo mk_option($cfg['REFRESH_ENABLED'] ?? '1', "1", _("Enabled"));?>
        <?php echo mk_option($cfg['REFRESH_ENABLED'] ?? '1', "0", _("Disabled"));?>
      </select>
    </span>

  _(Refresh Interval (seconds))_:
  : <span class="scriptlogs-control">
      <input type="number" name="REFRESH_INTERVAL" class="form-control" min="1" value="<?php echo htmlspecialchars($cfg['REFRESH_INTERVAL'] ?? '10'); ?>">
    </span>

  _(Show Last Log for Idle Scripts)_:
  : <span class="scriptlogs-control">
      <label>
        <input type="checkbox" name="SHOW_IDLE_LOGS" value="1" <?php echo (($cfg['SHOW_IDLE_LOGS'] ?? '0') === '1' ? 'checked' : ''); ?>>
        <span class="scriptlogs-hint"><?php echo _('Shows the last available log for scripts that ran in the background.'); ?></span>
      </label>
    </span>
  </dl>

  ### _(Script Selection)_
  <?php if (empty($available_scripts)): ?>
  <p><?php echo _('No user scripts found. Please create scripts in the "User Scripts" plugin first.'); ?></p>
  <?php else: ?>
  <p><?php echo _('Select which scripts should appear in the Scriptlogs dashboard widget.'); ?></p>
  <div class="scriptlogs-script-list">
    <?php foreach ($available_scripts as $script): ?>
      <?php $safe_script = htmlspecialchars($script); ?>
      <label class="scriptlogs-script-item">
        <input type="checkbox" name="ENABLED_SCRIPTS[]" value="<?php echo $safe_script; ?>" <?php echo (in_array($script, $enabled_scripts_array) ? 'checked' : ''); ?>>
        <span><?php echo $safe_script; ?></span>
      </label>
    <?php endforeach; ?>
  </div>
  <?php endif; ?>

  <div class="buttons-spaced">
    <input type="submit" name="#apply" value="<?php echo _('Apply'); ?>">
    <input type="button" value="<?php echo _('Done'); ?>" onclick="done()">
  </div>
  </div>
</form>