Menu="Dashboard:0"
Icon="ScriptLogsLogo.png"
---
<?php
require_once '/usr/local/emhttp/plugins/dynamix/include/Helpers.php';

$cfg = parse_plugin_cfg('scriptlogs', true);
$enabled_scripts_str = $cfg['ENABLED_SCRIPTS'] ?? '';
$enabled_scripts = !empty($enabled_scripts_str)
    ? array_values(array_filter(array_map('trim', explode(',', $enabled_scripts_str))))
    : [];

$tile_config = [
    'enabledScripts' => $enabled_scripts,
    'refreshEnabled' => ($cfg['REFRESH_ENABLED'] ?? '0') === '1',
    'refreshInterval' => intval($cfg['REFRESH_INTERVAL'] ?? 0) * 1000,
];

$tile_config_json = json_encode($tile_config, JSON_UNESCAPED_SLASHES);

$tile = [
    'name'   => 'scriptlogs',
    'title'  => 'Script Logs',
    'icon'   => 'fa-terminal',
    'content'=> '',
    'small'  => 1,
    'medium' => 1,
    'large'  => 2,
    'script' => '/plugins/scriptlogs/js/scriptlogs.js',
    'style'  => '/plugins/scriptlogs/css/scriptlogs.css',
];

$tile['content'] = <<<EOT
<div class="tile-header">
    <a id="scriptlogs-settings-icon" href="/Settings/ScriptlogsSettings" title="Scriptlogs Settings">
        <i class="fa fa-fw fa-cog control"></i>
    </a>
</div>

<div id="script-tabs-container"></div>

<div id="scriptlogs-container">
    <pre id="scriptlogs-logs">Select a script to see its log.</pre>
</div>

<div class="scriptlogs-timestamp-container">
    Last Update: <span id="scriptlogs-timestamp"></span>
</div>

<script>
    window.scriptlogsConfig = <?=$tile_config_json?>;
</script>
EOT;

if (!function_exists('create_tile')) {
    error_log('[scriptlogs] create_tile() is not available; dashboard tile cannot be registered.');
    return;
}

error_log('[scriptlogs] attempting to register tile: ' . json_encode([
    'name'   => $tile['name'] ?? null,
    'title'  => $tile['title'] ?? null,
    'script' => $tile['script'] ?? null,
    'style'  => $tile['style'] ?? null,
]));

$tile_markup = create_tile($tile);

if (empty($tile_markup)) {
    error_log('[scriptlogs] create_tile() returned empty markup; tile will not appear on dashboard.');
}

echo $tile_markup;
?>