Menu="Dashboard:0"
Icon="ScriptLogsLogo.png"
---
<?php
require_once '/usr/local/emhttp/plugins/dynamix/include/Helpers.php';

$cfg = parse_plugin_cfg('scriptlogs', true);
$enabled_scripts_str = $cfg['ENABLED_SCRIPTS'] ?? '';
$enabled_scripts = !empty($enabled_scripts_str)
    ? array_values(array_filter(array_map('trim', explode(',', $enabled_scripts_str))))
    : [];

$tile_config = [
    'enabledScripts' => $enabled_scripts,
    'refreshEnabled' => ($cfg['REFRESH_ENABLED'] ?? '0') === '1',
    'refreshInterval' => intval($cfg['REFRESH_INTERVAL'] ?? 0) * 1000,
];

$version_data = @parse_ini_file('/etc/unraid-version');
$webgui_version = $version_data['version'] ?? '0.0.0';
$isResponsiveWebgui = version_compare($webgui_version, '7.2.0-beta', '>=');

$tile_config['isResponsive'] = $isResponsiveWebgui;
$tile_config_json = json_encode($tile_config, JSON_UNESCAPED_SLASHES);

$tile = [
    'name'   => 'scriptlogs',
    'title'  => 'Script Logs',
    'icon'   => 'fa-terminal',
    'content'=> '',
    'small'  => 1,
    'medium' => 1,
    'large'  => 2,
    'script' => '/plugins/scriptlogs/js/scriptlogs.js',
    'style'  => '/plugins/scriptlogs/css/scriptlogs.css',
];

$tile_title = htmlspecialchars(_('Script Logs'), ENT_QUOTES, 'UTF-8');
$tile_subtitle = htmlspecialchars(_('Monitor user scripts'), ENT_QUOTES, 'UTF-8');
$tabs_aria_label = htmlspecialchars(_('Script logs tabs'), ENT_QUOTES, 'UTF-8');
$log_placeholder = htmlspecialchars(_('Select a script to see its log.'), ENT_QUOTES, 'UTF-8');
$last_update_label = htmlspecialchars(_('Last Update:'), ENT_QUOTES, 'UTF-8');

$common_body = <<<HTML
<div class="scriptlogs-body">
    <div id="script-tabs-container" class="scriptlogs-tabs" role="tablist" aria-label="{$tabs_aria_label}"></div>

    <div id="scriptlogs-container" class="scriptlogs-log" role="log" aria-live="polite">
        <pre id="scriptlogs-logs">{$log_placeholder}</pre>
    </div>

    <div class="scriptlogs-timestamp-container">
        <span class="scriptlogs-timestamp-label">{$last_update_label}</span>
        <span id="scriptlogs-timestamp"></span>
    </div>
</div>

<script>
    window.scriptlogsConfig = {$tile_config_json};
</script>
HTML;

if ($isResponsiveWebgui) {
    $tile['content'] = <<<HTML
<span class="tile-header">
    <span class="tile-header-left">
        <i class="fa fa-terminal f32" aria-hidden="true"></i>
        <div class="section">
            <h3 class="tile-header-main">{$tile_title}</h3>
            <span>{$tile_subtitle}</span>
        </div>
    </span>
    <span class="tile-header-right">
        <span class="tile-ctrl"></span>
        <span class="tile-header-right-controls">
            <a id="scriptlogs-settings-icon" href="/Settings/ScriptlogsSettings" title="Scriptlogs Settings" aria-label="Scriptlogs Settings">
                <i class="fa fa-fw fa-cog control" aria-hidden="true"></i>
            </a>
        </span>
    </span>
</span>
{$common_body}
HTML;
} else {
    $tile['content'] = <<<HTML
<div class="scriptlogs-legacy-header">
    <i class="fa fa-terminal f24" aria-hidden="true"></i>
    <div class="section">
        <span class="scriptlogs-legacy-title">{$tile_title}</span><br>
        <span class="scriptlogs-legacy-subtitle">{$tile_subtitle}</span>
    </div>
    <span class="scriptlogs-legacy-controls">
        <a id="scriptlogs-settings-icon" href="/Settings/ScriptlogsSettings" title="Scriptlogs Settings" aria-label="Scriptlogs Settings">
            <i class="fa fa-fw fa-cog control" aria-hidden="true"></i>
        </a>
    </span>
</div>
{$common_body}
HTML;
}

if (!function_exists('create_tile')) {
    error_log('[scriptlogs] create_tile() is not available; dashboard tile cannot be registered.');
    return;
}

error_log('[scriptlogs] attempting to register tile: ' . json_encode([
    'name'   => $tile['name'] ?? null,
    'title'  => $tile['title'] ?? null,
    'script' => $tile['script'] ?? null,
    'style'  => $tile['style'] ?? null,
]));

$tile_markup = create_tile($tile);

if (empty($tile_markup)) {
    error_log('[scriptlogs] create_tile() returned empty markup; tile will not appear on dashboard.');
}

echo $tile_markup;
?>