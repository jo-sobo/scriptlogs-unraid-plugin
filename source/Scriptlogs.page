Menu="Dashboard"
Icon="ScriptLogsLogo.png"
---
<?php
require_once '/usr/local/emhttp/plugins/dynamix/include/Helpers.php';

$logFile = '/tmp/user.scripts/logs/in_progress';

// AJAX-Handler
if (isset($_GET['action']) && $_GET['action'] === 'getLogs') {
    header('Content-Type: application/json');
    
    $logs = '';
    $fileExists = file_exists($logFile);
    
    if ($fileExists) {
        $lines = file($logFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
        if ($lines !== false) {
            $last_lines = array_slice($lines, -50);
            $logs = htmlspecialchars(implode("\n", $last_lines), ENT_QUOTES, 'UTF-8');
        } else {
            $logs = 'Fehler beim Lesen der Log-Datei.';
        }
    } else {
        $logs = 'Log-Datei nicht vorhanden.';
    }
    
    echo json_encode([
        'logs' => $logs,
        'lineCount' => substr_count($logs, "\n") + 1,
        'fileExists' => $fileExists
    ]);
    exit;
}

// Initial logs laden
$initialLogs = '';
$fileExists = file_exists($logFile);

if ($fileExists) {
    $lines = file($logFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    if ($lines !== false && count($lines) > 0) {
        $last_lines = array_slice($lines, -50);
        $initialLogs = htmlspecialchars(implode("\n", $last_lines), ENT_QUOTES, 'UTF-8');
    } else {
        $initialLogs = 'Log-Datei ist leer.';
    }
} else {
    $initialLogs = 'Log-Datei nicht vorhanden.';
}

$initialLineCount = max(1, substr_count($initialLogs, "\n") + 1);
?>

<style type="text/css">
    @import url("/plugins/scriptlogs/css/scriptlogs.css");
</style>

<table id='db-scriptlogs' class='dash_scriptlogs dashboard box1' style='display:none'>
    <thead sort='955'><tr class='hidden'><td></td><td colspan='3'></td><td></td></tr></thead>
    <tbody sort='955' class='sortable'>
        <tr>
            <td></td>
            <td class='next' colspan='3'>
                <i class='fa fa-terminal'></i>
                <div class='section'>Script Logs<br>
                    <span id='scriptlogs-status'>Status: <span class='scriptlogs-entries'><?= $initialLineCount ?> Zeilen</span></span>
                </div>
                <i class='fa fa-fw chevron mt0' id='dash_scriptlogs_toggle' onclick='toggleChevron("dash_scriptlogs_toggle",0)'></i>
                <br><br>
            </td>
            <td></td>
        </tr>
        <tr class="dash_scriptlogs_toggle scriptlogs-content">
            <td></td>
            <td colspan="3">
                <div id="scriptlogs-container" style="height:200px; overflow-y:auto; font-family: monospace; font-size: 11px; background-color: #1a1a1a; color: #e0e0e0; padding: 8px; border: 1px solid #444; border-radius: 3px;">
                    <pre id="scriptlogs-logs" style="margin: 0; white-space: pre-wrap; word-wrap: break-word;"><?= $initialLogs ?></pre>
                </div>
                <div style="margin-top: 5px; font-size: 10px; color: #888; text-align: right;">
                    Letztes Update: <span id="scriptlogs-timestamp"><?= date('H:i:s') ?></span>
                </div>
            </td>
            <td></td>
        </tr>
    </tbody>
</table>

<script type="text/javascript" src="/plugins/scriptlogs/js/scriptlogs.js"></script>
<script type="text/javascript">
    $(scriptlogs_status);
    setInterval(scriptlogs_status, 5000); // Auto-refresh alle 5 Sekunden
    $(scriptlogs_dash);
</script>