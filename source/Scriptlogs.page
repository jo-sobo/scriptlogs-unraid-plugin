Menu="Dashboard:0"
Icon="ScriptLogsLogo.png"
---
<?php
require_once '/usr/local/emhttp/plugins/dynamix/include/Helpers.php';

$cfg = parse_plugin_cfg('scriptlogs', true);
$enabled_scripts_str = $cfg['ENABLED_SCRIPTS'] ?? '';
$enabled_scripts = !empty($enabled_scripts_str)
    ? array_values(array_filter(array_map('trim', explode(',', $enabled_scripts_str))))
    : [];

$tile_config = [
    'enabledScripts' => $enabled_scripts,
    'refreshEnabled' => ($cfg['REFRESH_ENABLED'] ?? '0') === '1',
    'refreshInterval' => intval($cfg['REFRESH_INTERVAL'] ?? 0) * 1000,
    'fontSize' => $cfg['LOG_FONT_SIZE'] ?? '1rem',
];

// Determine tile version (responsive vs legacy)
$version_override = $cfg['VERSION_OVERRIDE'] ?? 'auto';

if ($version_override === 'legacy') {
    $isResponsiveWebgui = false;
} elseif ($version_override === 'responsive') {
    $isResponsiveWebgui = true;
} else {
    // Auto-detect based on Unraid version
    $version_data = @parse_ini_file('/etc/unraid-version');
    $webgui_version = $version_data['version'] ?? '0.0.0';
    $isResponsiveWebgui = version_compare($webgui_version, '7.2.0-beta', '>=');
}

$tile_config['isResponsive'] = $isResponsiveWebgui;
$tile_config_json = json_encode($tile_config, JSON_UNESCAPED_SLASHES);

$tile = [
    'name'   => 'scriptlogs',
    'title'  => 'Script Logs',
    'icon'   => 'fa-terminal',
    'content'=> '',
    'small'  => 1,
    'medium' => 1,
    'large'  => 2,
    'script' => '/plugins/scriptlogs/js/scriptlogs.js',
    'style'  => '/plugins/scriptlogs/css/scriptlogs.css',
];

$tile_title = htmlspecialchars(_('Script Logs'), ENT_QUOTES, 'UTF-8');
$tile_subtitle = htmlspecialchars(_('Monitor user scripts'), ENT_QUOTES, 'UTF-8');
$tabs_aria_label = htmlspecialchars(_('Script logs tabs'), ENT_QUOTES, 'UTF-8');
$log_placeholder = htmlspecialchars(_('Select a script to see its log.'), ENT_QUOTES, 'UTF-8');
$last_update_label = htmlspecialchars(_('Last Update:'), ENT_QUOTES, 'UTF-8');

$tile_body = <<<HTML
<div class="scriptlogs-body">
    <div id="script-tabs-container" class="scriptlogs-tabs" role="tablist" aria-label="{$tabs_aria_label}"></div>
    
    <div class="scriptlogs-collapsible">
        <div id="scriptlogs-container" class="scriptlogs-log" role="log" aria-live="polite">
            <pre id="scriptlogs-logs">{$log_placeholder}</pre>
        </div>

        <div class="scriptlogs-footer">
            <div class="scriptlogs-autoscroll-container">
                <label class="scriptlogs-autoscroll-label">
                    <input type="checkbox" id="scriptlogs-autoscroll" class="scriptlogs-autoscroll-checkbox" checked>
                    <span class="scriptlogs-autoscroll-text">Autoscroll</span>
                </label>
            </div>
            <div class="scriptlogs-timestamp-container">
                <span class="scriptlogs-timestamp-label">{$last_update_label}</span>
                <span id="scriptlogs-timestamp"></span>
            </div>
        </div>
    </div>
</div>
HTML;

$compact_indicators = <<<HTML
<div id="scriptlogs-compact-indicators" class="scriptlogs-compact-indicators" style="display: none;"></div>
HTML;

$config_script = <<<HTML
<script>
    window.scriptlogsConfig = {$tile_config_json};
</script>
HTML;

if ($isResponsiveWebgui) {
    $tile['content'] = <<<HTML
<span class="tile-header scriptlogs-header">
    <span class="tile-header-left scriptlogs-header__left">
        <i class="fa fa-terminal scriptlogs-header__icon" aria-hidden="true"></i>
        <div class="section">
            <h3 class="tile-header-main scriptlogs-header__title">{$tile_title}</h3>
            {$compact_indicators}
        </div>
    </span>
    <span class="tile-header-right scriptlogs-header__right">
        <span class="tile-ctrl"></span>
        <span class="tile-header-right-controls">
            <a id="scriptlogs-settings-icon" href="/Settings/ScriptlogsSettings" title="Scriptlogs Settings" aria-label="Scriptlogs Settings">
                <i class="fa fa-fw fa-cog control" aria-hidden="true"></i>
            </a>
            <i class="fa fa-fw fa-chevron-up control openclose" onclick="openClose($(this))" title="Show/Hide Content"></i>
        </span>
    </span>
</span>
{$tile_body}
{$config_script}
HTML;
} else {
    $tile['content'] = <<<HTML
<div class="scriptlogs-legacy-header">
    <span class="scriptlogs-legacy-header__left">
        <i class="fa fa-terminal scriptlogs-legacy-header__icon" aria-hidden="true"></i>
        <span class="scriptlogs-legacy-title">{$tile_title}</span>
    </span>
    <span class="scriptlogs-legacy-controls">
        <a id="scriptlogs-settings-icon" href="/Settings/ScriptlogsSettings" title="Scriptlogs Settings" aria-label="Scriptlogs Settings">
            <i class="fa fa-fw fa-cog control" aria-hidden="true"></i>
        </a>
        <i class="fa fa-fw fa-chevron-up control openclose" onclick="openClose($(this))" title="Show/Hide Content"></i>
    </span>
</div>
{$compact_indicators}
{$tile_body}
{$config_script}
HTML;
}

$legacy_tile_markup = <<<HTML
<link rel="stylesheet" type="text/css" href="/plugins/scriptlogs/css/scriptlogs.css">
<tbody id="db-scriptlogs" title="{$tile_title}">
    <tr>
        <td class="next" colspan="3">
            <div class="scriptlogs-legacy-header">
                <span class="scriptlogs-legacy-header__left">
                    <i class="fa fa-terminal scriptlogs-legacy-header__icon" aria-hidden="true"></i>
                    <span class="scriptlogs-legacy-title">{$tile_title}</span>
                </span>
                <span class="scriptlogs-legacy-controls">
                    <a id="scriptlogs-settings-icon" href="/Settings/ScriptlogsSettings" title="Scriptlogs Settings" aria-label="Scriptlogs Settings">
                        <i class="fa fa-fw fa-cog control" aria-hidden="true"></i>
                    </a>
                    <i class="fa fa-fw fa-chevron-up control openclose" onclick="openClose($(this))" title="Show/Hide Content"></i>
                </span>
            </div>
        </td>
    </tr>
    <tr>
        <td colspan="3">
            <div class="scriptlogs-body">
                <div id="script-tabs-container" class="scriptlogs-tabs" role="tablist" aria-label="{$tabs_aria_label}"></div>
            </div>
        </td>
    </tr>
    <tr class="dash_scriptlogs_toggle scriptlogs-content">
        <td colspan="3">
            <div class="scriptlogs-body">
                <div id="scriptlogs-container" class="scriptlogs-log" role="log" aria-live="polite">
                    <pre id="scriptlogs-logs">{$log_placeholder}</pre>
                </div>

                <div class="scriptlogs-footer">
                    <div class="scriptlogs-autoscroll-container">
                        <label class="scriptlogs-autoscroll-label">
                            <input type="checkbox" id="scriptlogs-autoscroll" class="scriptlogs-autoscroll-checkbox" checked>
                            <span class="scriptlogs-autoscroll-text">Autoscroll</span>
                        </label>
                    </div>
                    <div class="scriptlogs-timestamp-container">
                        <span class="scriptlogs-timestamp-label">{$last_update_label}</span>
                        <span id="scriptlogs-timestamp"></span>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</tbody>
{$config_script}
<script defer src="/plugins/scriptlogs/js/scriptlogs.js"></script>
HTML;

if (function_exists('register_dashboard_tile')) {
    $registration_result = @register_dashboard_tile($tile);

    if (is_string($registration_result) && trim($registration_result) !== '') {
        echo $registration_result;
        return;
    }

    if ($registration_result) {
        return;
    }

    error_log('[scriptlogs] register_dashboard_tile() returned falsy result; falling back to legacy tile registration.');
} else {
    error_log('[scriptlogs] register_dashboard_tile() is not available; falling back to legacy tile registration.');
}

$mytiles['scriptlogs']['column1'] = $legacy_tile_markup;
return;
?>